---
- name: Accept 80/tcp (http)
  iptables:
    chain: INPUT
    ip_version: "{{ item }}"
    protocol: tcp
    ctstate: NEW
    destination_port: '80'
    jump: ACCEPT
  with_items: ['ipv4', 'ipv6']

- name: Accept 443/tcp (https)
  iptables:
    chain: INPUT
    ip_version: "{{ item }}"
    protocol: tcp
    ctstate: NEW
    destination_port: '443'
    jump: ACCEPT
  with_items: ['ipv4', 'ipv6']

- name: Accept 25/tcp (smtp)
  iptables:
    chain: INPUT
    ip_version: "{{ item }}"
    protocol: tcp
    ctstate: NEW
    destination_port: '25'
    jump: ACCEPT
  with_items: ['ipv4', 'ipv6']

- name: Accept 587/tcp (submission)
  iptables:
    chain: INPUT
    ip_version: "{{ item }}"
    protocol: tcp
    ctstate: NEW
    destination_port: '587'
    jump: ACCEPT
  with_items: ['ipv4', 'ipv6']

- name: Accept 143/tcp (imap)
  iptables:
    chain: INPUT
    ip_version: "{{ item }}"
    protocol: tcp
    ctstate: NEW
    destination_port: '143'
    jump: ACCEPT
  with_items: ['ipv4', 'ipv6']

- name: Accept 1194/udp (openvpn)
  iptables:
    chain: INPUT
    ip_version: "{{ item }}"
    protocol: udp
    destination_port: '1194'
    jump: ACCEPT
  with_items: ['ipv4', 'ipv6']

- name: Accept 1701/udp (IPsec/L2TP)
  iptables:
    chain: INPUT
    ip_version: "{{ item }}"
    protocol: udp
    destination_port: '1701'
    jump: ACCEPT
  with_items: ['ipv4', 'ipv6']

- name: Accept esp (IPsec/L2TP)
  iptables:
    chain: INPUT
    ip_version: "{{ item }}"
    protocol: esp
    jump: ACCEPT
  with_items: ['ipv4', 'ipv6']

- name: Save iptables rules to file
  shell: "service ip{{ item }}tables save"
  args:
    warn: false
  with_items: ['', '6']
